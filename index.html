<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SpotMyPlaylist</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #0e0e0e;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .card {
      background-color: #181818;
      border: 1px solid #2a2a2a;
      padding: 40px;
      border-radius: 16px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
    }
    h1 {
      text-align: center;
      margin-bottom: 8px;
      font-weight: 700;
      font-size: 1.8rem;
    }
    p.subtitle {
      text-align: center;
      color: #b3b3b3;
      font-size: 0.95rem;
      margin-bottom: 24px;
    }
    .status {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
      font-size: 0.9rem;
    }
    .status span {
      color: #888;
    }
    .status .connected {
      color: #1DB954;
      font-weight: 600;
    }
    button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      background-color: #1DB954;
      color: #000;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:disabled {
      background-color: #3a3a3a;
      color: #777;
      cursor: default;
    }
    .progress-wrapper {
      margin-top: 32px;
    }
    progress {
      width: 100%;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
    }
    .info {
      font-size: 0.8rem;
      text-align: center;
      color: #aaa;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>SpotMyPlaylist BAZAAT !!</h1>
    <p class="subtitle">Transfer playlists between Spotify accounts easily</p>

    <div class="status">
      <div>Source: <span id="sourceStatus">Not Connected</span></div>
      <div>Destination: <span id="destStatus">Not Connected</span></div>
    </div>

    <button id="sourceLoginBtn">Login as Source Account</button>
    <button id="destLoginBtn">Login as Destination Account</button>
    <button id="transferBtn" disabled>Transfer Playlists</button>

    <div class="progress-wrapper">
      <progress id="transferProgressBar" value="0" max="100"></progress>
      <div class="info" id="transferStatus">Waiting for login...</div>
      <div class="info" id="transferPercentage">0%</div>
    </div>
  </div>

<script>
const clientId = "f3fd2e13bd8046e4b801f01e43b4500b";
const redirectUri = "https://www.spotmyplaylist.site/";
const scopes = "playlist-read-private playlist-read-collaborative playlist-modify-private playlist-modify-public user-library-read user-follow-read";

let accessToken1 = null;
let accessToken2 = null;
let userId1 = null;
let userId2 = null;

function generateCodeVerifier(length = 128) {
  const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  let result = "";
  for (let i = 0; i < length; i++) {
    result += charset.charAt(Math.floor(Math.random() * charset.length));
  }
  return result;
}

async function generateCodeChallenge(codeVerifier) {
  const data = new TextEncoder().encode(codeVerifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function loginSpotify(accountLabel) {
  const verifier = generateCodeVerifier();
  const challenge = await generateCodeChallenge(verifier);
  localStorage.setItem("verifier_" + accountLabel, verifier);

  const state = accountLabel + "_" + Math.random().toString(36).substring(2, 15);
  localStorage.setItem("state", state);

  const params = new URLSearchParams({
    client_id: clientId,
    response_type: "code",
    redirect_uri: redirectUri,
    scope: scopes,
    state: state,
    code_challenge_method: "S256",
    code_challenge: challenge
  });

  window.location.href = "https://accounts.spotify.com/authorize?" + params.toString();
}

async function exchangeToken(code, accountLabel) {
  const verifier = localStorage.getItem("verifier_" + accountLabel);
  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: "authorization_code",
    code: code,
    redirect_uri: redirectUri,
    code_verifier: verifier
  });

  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body
  });

  const data = await response.json();
  if (data.access_token) {
    localStorage.setItem("access_token_" + accountLabel, data.access_token);
    if (accountLabel === "source") {
      accessToken1 = data.access_token;
      userId1 = await getUserId(accessToken1);
    } else {
      accessToken2 = data.access_token;
      userId2 = await getUserId(accessToken2);
    }
    updateStatus(accountLabel, true);
    checkTransferReady();
    window.history.replaceState({}, document.title, "/");
    window.location.reload();
  }
}

async function getUserId(token) {
  const response = await fetch("https://api.spotify.com/v1/me", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await response.json();
  return data.id;
}

function updateStatus(account, connected) {
  const el = document.getElementById(account === "source" ? "sourceStatus" : "destStatus");
  if (el && connected) {
    el.textContent = "Connected";
    el.classList.remove("text-gray-400");
    el.classList.add("text-green-400", "font-semibold");
  }
}

function tryRestoreTokens() {
  accessToken1 = localStorage.getItem("access_token_source");
  accessToken2 = localStorage.getItem("access_token_target");

  if (accessToken1) {
    getUserId(accessToken1).then(id => userId1 = id);
    updateStatus("source", true);
  }
  if (accessToken2) {
    getUserId(accessToken2).then(id => userId2 = id);
    updateStatus("target", true);
  }
  checkTransferReady();
}

function checkTransferReady() {
  const btn = document.getElementById("transferBtn");
  if (accessToken1 && accessToken2) {
    btn.disabled = false;
  }
}

async function transferPlaylists() {
  if (!accessToken1 || !accessToken2) return alert("Please connect both accounts first.");
  const status = document.getElementById("transferStatus");
  const bar = document.getElementById("transferProgressBar");
  const percent = document.getElementById("transferPercentage");

  status.textContent = "Starting transfer...";
  bar.value = 0;
  percent.textContent = "0%";

  // Transfer playlists
  await transferUserPlaylists();

  // Transfer saved tracks
  await transferSavedTracks();

  // Transfer followed artists
  await transferFollowedArtists();

  // Transfer saved albums
  await transferSavedAlbums();

  // Transfer saved shows (podcasts)
  await transferSavedShows();

  status.textContent = "âœ… Transfer complete!";
}

async function transferUserPlaylists() {
  const status = document.getElementById("transferStatus");
  const bar = document.getElementById("transferProgressBar");
  const percent = document.getElementById("transferPercentage");

  status.textContent = "Fetching playlists...";
  
  let playlists = [];
  let url = "https://api.spotify.com/v1/me/playlists?limit=50";
  
  while (url) {
    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + accessToken1 }
    });
    const data = await res.json();
    playlists = playlists.concat(data.items);
    url = data.next;
  }

  bar.max = playlists.length;
  bar.value = 0;
  percent.textContent = "0%";

  for (let i = 0; i < playlists.length; i++) {
    const pl = playlists[i];
    const isOwner = pl.owner.id === userId1;
    
    status.textContent = isOwner ? `Transferring (owner): ${pl.name}` : `Following: ${pl.name}`;

    if (isOwner) {
      // Transfer owned playlists
      const newPlaylist = await createPlaylist(pl);
      if (pl.images.length > 0) {
        await uploadPlaylistImage(newPlaylist.id, pl.images[0].url);
      }
      if (pl.tracks.total > 0) {
        await transferPlaylistTracks(pl.id, newPlaylist.id);
      }
    } else {
      // Follow non-owned playlists
      await followPlaylist(pl.id);
    }

    bar.value = i + 1;
    percent.textContent = Math.round(((i + 1) / playlists.length) * 100) + "%";
    await new Promise(r => setTimeout(r, 300));
  }
}

async function createPlaylist(playlist) {
  const response = await fetch(`https://api.spotify.com/v1/users/${userId2}/playlists`, {
    method: "POST",
    headers: {
      Authorization: "Bearer " + accessToken2,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      name: playlist.name,
      description: playlist.description || "",
      public: playlist.public
    })
  });
  return await response.json();
}

async function uploadPlaylistImage(playlistId, imageUrl) {
  try {
    // Fetch the image
    const imageResponse = await fetch(imageUrl);
    const blob = await imageResponse.blob();
    
    // Convert to base64
    const reader = new FileReader();
    reader.readAsDataURL(blob);
    await new Promise(resolve => reader.onload = resolve);
    
    // Extract base64 data
    const base64Data = reader.result.split(',')[1];
    
    // Upload to Spotify
    await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/images`, {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + accessToken2,
        "Content-Type": "image/jpeg"
      },
      body: base64Data
    });
  } catch (error) {
    console.error("Error uploading playlist image:", error);
  }
}

async function transferPlaylistTracks(sourceId, targetId) {
  let tracks = [];
  let url = `https://api.spotify.com/v1/playlists/${sourceId}/tracks?limit=100`;
  
  while (url) {
    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + accessToken1 }
    });
    const data = await res.json();
    tracks = tracks.concat(data.items);
    url = data.next;
  }

  const trackUris = tracks.map(item => item.track.uri).filter(uri => uri);
  
  // Add tracks in batches of 100 (Spotify limit)
  for (let i = 0; i < trackUris.length; i += 100) {
    const batch = trackUris.slice(i, i + 100);
    await fetch(`https://api.spotify.com/v1/playlists/${targetId}/tracks`, {
      method: "POST",
      headers: {
        Authorization: "Bearer " + accessToken2",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        uris: batch,
        position: i
      })
    });
    await new Promise(r => setTimeout(r, 300));
  }
}

async function followPlaylist(playlistId) {
  await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/followers`, {
    method: "PUT",
    headers: {
      Authorization: "Bearer " + accessToken2,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      public: false
    })
  });
}

async function transferSavedTracks() {
  const status = document.getElementById("transferStatus");
  status.textContent = "Transferring saved tracks...";
  
  let tracks = [];
  let url = "https://api.spotify.com/v1/me/tracks?limit=50";
  
  while (url) {
    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + accessToken1 }
    });
    const data = await res.json();
    tracks = tracks.concat(data.items);
    url = data.next;
  }

  const trackUris = tracks.map(item => item.track.uri).filter(uri => uri);
  
  // Add tracks in batches of 50 (Spotify limit for this endpoint)
  for (let i = 0; i < trackUris.length; i += 50) {
    const batch = trackUris.slice(i, i + 50);
    await fetch("https://api.spotify.com/v1/me/tracks", {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + accessToken2,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        ids: batch.map(uri => uri.split(':')[2])
      })
    });
    await new Promise(r => setTimeout(r, 300));
  }
}

async function transferFollowedArtists() {
  const status = document.getElementById("transferStatus");
  status.textContent = "Transferring followed artists...";
  
  let artists = [];
  let url = "https://api.spotify.com/v1/me/following?type=artist&limit=50";
  
  while (url) {
    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + accessToken1 }
    });
    const data = await res.json();
    artists = artists.concat(data.artists.items);
    url = data.artists.next;
  }

  const artistIds = artists.map(artist => artist.id).filter(id => id);
  
  // Follow artists in batches of 50 (Spotify limit)
  for (let i = 0; i < artistIds.length; i += 50) {
    const batch = artistIds.slice(i, i + 50);
    await fetch("https://api.spotify.com/v1/me/following", {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + accessToken2,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        type: "artist",
        ids: batch
      })
    });
    await new Promise(r => setTimeout(r, 300));
  }
}

async function transferSavedAlbums() {
  const status = document.getElementById("transferStatus");
  status.textContent = "Transferring saved albums...";
  
  let albums = [];
  let url = "https://api.spotify.com/v1/me/albums?limit=50";
  
  while (url) {
    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + accessToken1 }
    });
    const data = await res.json();
    albums = albums.concat(data.items);
    url = data.next;
  }

  const albumIds = albums.map(item => item.album.id).filter(id => id);
  
  // Save albums in batches of 50 (Spotify limit)
  for (let i = 0; i < albumIds.length; i += 50) {
    const batch = albumIds.slice(i, i + 50);
    await fetch("https://api.spotify.com/v1/me/albums", {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + accessToken2,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        ids: batch
      })
    });
    await new Promise(r => setTimeout(r, 300));
  }
}

async function transferSavedShows() {
  const status = document.getElementById("transferStatus");
  status.textContent = "Transferring saved podcasts...";
  
  let shows = [];
  let url = "https://api.spotify.com/v1/me/shows?limit=50";
  
  while (url) {
    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + accessToken1 }
    });
    const data = await res.json();
    shows = shows.concat(data.items);
    url = data.next;
  }

  const showIds = shows.map(item => item.show.id).filter(id => id);
  
  // Save shows in batches of 50 (Spotify limit)
  for (let i = 0; i < showIds.length; i += 50) {
    const batch = showIds.slice(i, i + 50);
    await fetch("https://api.spotify.com/v1/me/shows", {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + accessToken2,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        ids: batch
      })
    });
    await new Promise(r => setTimeout(r, 300));
  }
}

window.onload = function () {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const state = params.get("state");

  if (code && state) {
    const label = state.split("_")[0];
    exchangeToken(code, label);
  } else {
    tryRestoreTokens();
  }

  document.getElementById("sourceLoginBtn").onclick = () => loginSpotify("source");
  document.getElementById("destLoginBtn").onclick = () => loginSpotify("target");
  document.getElementById("transferBtn").onclick = () => transferPlaylists();
};
</script>

</body>
</html>
